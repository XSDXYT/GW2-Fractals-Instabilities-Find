<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GW2 Fractal CM(95-100) 异变查询（GitHub Pages）</title>
  <style>
    :root{ --card:#111a2e; --text:#e8eefc; --muted:#9fb0d0; --line:#243251; --accent:#7aa2ff; --bad:#ff6b6b; --good:#39d98a; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC","Microsoft YaHei", sans-serif;
      background:linear-gradient(180deg,#071028 0%, #050a14 100%); color:var(--text); }
    .wrap{ max-width:1150px; margin:0 auto; padding:18px 14px 40px; }
    h1{ font-size:20px; margin:8px 0 14px; font-weight:700; }
    .row{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width:940px){ .row{ grid-template-columns: 390px 1fr; } }
    .card{ background:rgba(17,26,46,.92); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:0 8px 24px rgba(0,0,0,.3); }
    .sub{ color:var(--muted); font-size:12px; line-height:1.55; }
    .status{ font-size:12px; padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:rgba(255,255,255,.03); }
    .status.ok{ border-color:rgba(57,217,138,.35); }
    .status.bad{ border-color:rgba(255,107,107,.45); }
    .controls{ display:grid; gap:10px; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:4px;}
    input, select, button{
      width:100%; padding:10px 10px; border-radius:10px; border:1px solid var(--line);
      background:rgba(255,255,255,.03); color:var(--text); outline:none;
    }
    button{ cursor:pointer; background:rgba(122,162,255,.14); border-color:rgba(122,162,255,.35); }
    button:hover{ background:rgba(122,162,255,.22); }
    .btns{ display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; }
    .pill{ display:inline-flex; gap:8px; align-items:center; font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--muted); }
    .pill b{ color:var(--text); font-weight:650; }
    table{ width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px; border:1px solid var(--line); }
    th,td{ padding:10px 10px; border-bottom:1px solid var(--line); vertical-align:top; }
    th{ text-align:left; font-size:12px; color:var(--muted); background:rgba(255,255,255,.03); }
    td{ font-size:13px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .small{ font-size:12px; color:var(--muted); }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .lines{ line-height:1.65; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>GW2 Fractal CM（95–100）异变查询（在线表格版）</h1>

  <div class="row">
    <div class="card">
      <div id="status" class="status">正在加载 JSON…</div>
      <div class="hr"></div>

      <div class="controls">
        <div>
          <label>选择日期</label>
          <input id="dateInput" type="date" />
          <div class="btns" style="margin-top:8px;">
            <button id="btnToday">今天</button>
            <button id="btnTomorrow">明天</button>
            <button id="btnPlus7">+7天</button>
            <button id="btnPlus30">+30天</button>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>未来天数（表格）</label>
            <input id="rangeDays" type="number" min="1" max="180" value="30" />
          </div>
          <div>
            <label>反查窗口（天）</label>
            <input id="reverseDays" type="number" min="1" max="365" value="90" />
          </div>
        </div>

        <div>
          <label>按异变反查（未来）</label>
          <select id="instabSelect"></select>
        </div>

        <button id="btnBuild">生成/刷新表格</button>

        <div class="sub">
          本页面只展示 CM 六个碎层（Scale 95–100）：Kinfall、Nightmare、Shattered Observatory、Sunqua Peak、Silent Surf、Lonely Tower。<br/>
          JSON 读取路径（同目录）：<span class="mono">./instabilities.json</span>、<span class="mono">./fractals.json</span>、<span class="mono">./zh_dict.json</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <span class="pill">当前日期：<b id="curDateText">—</b></span>
        <span class="pill">当日异变：<b id="curInstabText">—</b></span>
      </div>

      <div class="hr"></div>

      <div id="dayPanel">
        <div class="small" style="margin-bottom:8px;">当日 CM（95–100）异变</div>
        <div style="overflow:auto; border-radius:12px;">
          <table>
            <thead>
              <tr>
                <th style="width:70px;">Scale</th>
                <th style="width:240px;">碎层</th>
                <th>异变 1</th>
                <th>异变 2</th>
              </tr>
            </thead>
            <tbody id="cmTbody">
              <tr><td colspan="4" class="small">等待数据…</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="hr"></div>

      <div>
        <div class="small" style="margin-bottom:8px;">未来表格（每天的 CM 95–100 异变）</div>
        <div style="overflow:auto; border-radius:12px;">
          <table>
            <thead>
              <tr>
                <th style="width:120px;">日期</th>
                <th style="width:220px;">异变 1</th>
                <th style="width:220px;">异变 2</th>
                <th>CM 95–100（同一对异变）</th>
              </tr>
            </thead>
            <tbody id="futureTbody">
              <tr><td colspan="4" class="small">点击“生成/刷新表格”</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="hr"></div>

      <div>
        <div class="small" style="margin-bottom:8px;">异变反查（未来出现日期，适用于 CM 95–100）</div>
        <div id="reverseBox" class="small">请选择异变后自动刷新</div>
      </div>
    </div>
  </div>
</div>

<script>
  // ========= Utils =========
  const pad2 = n => String(n).padStart(2,'0');
  const toISODate = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const parseISODate = (s) => {
    const [y,m,dd] = s.split('-').map(Number);
    return new Date(y, (m||1)-1, dd||1);
  };
  const addDays = (d, n) => {
    const x = new Date(d.getTime());
    x.setDate(x.getDate() + n);
    return x;
  };
  const safeText = (v) => (v === undefined || v === null) ? '' : String(v);

  async function fetchJson(url){
    const r = await fetch(url, { cache: "no-store" });
    if(!r.ok){
      throw new Error(`HTTP ${r.status} ${r.statusText} - ${url}`);
    }
    return await r.json();
  }

  // ========= Data holders =========
  let instData = null;
  let fracData = null;
  let zh = null;
  let cmScales = []; // [{scale:95,type:"kinfall", enName:"Kinfall", zhName:"族亲陨落"}...]

  // ========= Translation helpers =========
  function zhLookup(section, key){
    const sec = zh?.[section];
    if(!sec) return null;
    const k1 = String(key);
    return sec[k1] ?? sec[key] ?? null;
  }

  function resolveInstabEN(id){
    if(!instData) return null;
    const sid = String(id);
    if(instData.names && instData.names[sid]) return instData.names[sid];
    const arr = instData.instabilities || instData.list || null;
    if(Array.isArray(arr)){
      const hit = arr.find(x => String(x.id) === sid || String(x.key) === sid);
      if(hit) return hit.name || hit.en || hit.title || null;
    }
    return null;
  }

  function instabName(idOrName){
    const zDirect = zhLookup("instabilities", idOrName);
    if(zDirect) return { zh:zDirect, en: safeText(idOrName) };

    const en = resolveInstabEN(idOrName) || safeText(idOrName);
    const z2 = zhLookup("instabilities", String(idOrName)) ?? zhLookup("instabilities", en);
    return { zh: z2 ?? "", en };
  }

  function prettyInstab(idOrName){
    const n = instabName(idOrName);
    return n.zh ? `${n.zh} <span class="small">(${n.en})</span>` : safeText(n.en);
  }

  function prettyFractal(fr){
    const en = fr.enName || fr.type || "";
    const z =
      fr.zhName ||
      zhLookup("fractals", fr.type) ||
      zhLookup("fractals", en) ||
      zhLookup("fractals", String(fr.scale)) ||
      "";
    return z ? `${z} <span class="small">(${en})</span>` : safeText(en);
  }

  // ========= Instabilities for a date =========
  function getInstabsForDate(iso){
    if(!instData) return null;

    // A) direct by date
    if(typeof instData === "object" && instData[iso] && Array.isArray(instData[iso])) return instData[iso];
    if(instData.byDate && instData.byDate[iso]) return instData.byDate[iso];
    if(instData.dates && instData.dates[iso]) return instData.dates[iso];

    // B) rotation + startDate
    const rotation = instData.rotation || instData.schedule || instData.days || null;
    const start = instData.startDate || instData.start_date || instData.rotationStart || instData.base_date || null;

    if(Array.isArray(rotation) && start){
      const d = parseISODate(iso);
      const base = parseISODate(String(start).slice(0,10));
      const diff = Math.floor((d - base) / 86400000);
      const len = rotation.length;
      const idx = ((diff % len) + len) % len;
      const val = rotation[idx];
      if(Array.isArray(val)) return val;
      if(val && Array.isArray(val.instabilities)) return val.instabilities;
      if(val && Array.isArray(val.ids)) return val.ids;
    }
    return null;
  }

  // ========= CM list: scales 95-100 =========
  function buildCMList(){
    cmScales = [];
    const scales = fracData?.scales;
    const details = fracData?.fractal_details;
    if(!Array.isArray(scales)) return;

    const hits = scales
      .filter(x => typeof x?.scale === "number" && x.scale >= 95 && x.scale <= 100)
      .sort((a,b)=>a.scale-b.scale);

    hits.forEach(x => {
      const type = x.type;
      const enName = details?.[type]?.name?.en || type || "";
      const zhName = zhLookup("fractals", type) || zhLookup("fractals", enName) || "";
      cmScales.push({ scale:x.scale, type, enName, zhName });
    });
  }

  // ========= UI =========
  function setStatus(ok, msg){
    const el = document.getElementById("status");
    el.className = "status " + (ok ? "ok" : "bad");
    el.innerHTML = msg;
  }

  function renderDay(iso){
    document.getElementById("curDateText").textContent = iso;

    const ids = getInstabsForDate(iso);
    const cmTbody = document.getElementById("cmTbody");
    cmTbody.innerHTML = "";

    if(!ids || ids.length < 2){
      document.getElementById("curInstabText").textContent = "—";
      cmTbody.innerHTML = `
        <tr><td colspan="4" style="color:var(--bad);">
          解析不到该日期的异变。请检查 instabilities.json 的结构是否为：<br/>
          ① 直接按日期映射：<span class="mono">{"YYYY-MM-DD":[id1,id2],...}</span><br/>
          或 ② 有 <span class="mono">startDate</span> + <span class="mono">rotation</span>（数组轮换）
        </td></tr>
      `;
      return;
    }

    const n1 = instabName(ids[0]);
    const n2 = instabName(ids[1]);
    document.getElementById("curInstabText").textContent = `${n1.zh || n1.en} / ${n2.zh || n2.en}`;

    const cell1 = prettyInstab(ids[0]);
    const cell2 = prettyInstab(ids[1]);

    if(!cmScales.length){
      cmTbody.innerHTML = `<tr><td colspan="4" style="color:var(--bad);">fractals.json 未解析到 Scale 95–100，请确认文件内容。</td></tr>`;
      return;
    }

    cmScales.forEach(fr => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${fr.scale}</td>
        <td>${prettyFractal(fr)}</td>
        <td>${cell1}</td>
        <td>${cell2}</td>
      `;
      cmTbody.appendChild(tr);
    });
  }

  function renderFuture(startIso, days){
    const tbody = document.getElementById("futureTbody");
    tbody.innerHTML = "";
    const start = parseISODate(startIso);

    for(let i=0;i<days;i++){
      const d = addDays(start, i);
      const iso = toISODate(d);
      const ids = getInstabsForDate(iso);

      const n1 = (ids && ids.length>=2) ? instabName(ids[0]) : {zh:"",en:"—"};
      const n2 = (ids && ids.length>=2) ? instabName(ids[1]) : {zh:"",en:"—"};

      const c1 = n1.zh ? `${n1.zh} (${n1.en})` : safeText(n1.en);
      const c2 = n2.zh ? `${n2.zh} (${n2.en})` : safeText(n2.en);

      const list = cmScales.map(fr=>{
        const z = fr.zhName || "";
        const en = fr.enName || fr.type || "";
        const name = z ? `${fr.scale} ${z} (${en})` : `${fr.scale} ${en}`;
        return `${name}：${c1} / ${c2}`;
      }).join("<br/>");

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${iso}</td>
        <td>${safeText(c1)}</td>
        <td>${safeText(c2)}</td>
        <td class="lines">${list}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function buildInstabDropdown(){
    const sel = document.getElementById("instabSelect");
    sel.innerHTML = "";

    const map = zh?.instabilities;
    const keys = map ? Object.keys(map) : [];

    let options = [];
    if(keys.length){
      options = keys.map(k => {
        const z = map[k];
        const en = resolveInstabEN(k) || (isNaN(Number(k)) ? k : `ID ${k}`);
        return { key:k, label: z ? `${z} (${en})` : safeText(en) };
      });
    }else{
      const rot = instData?.rotation || instData?.schedule || null;
      const s = new Set();
      if(Array.isArray(rot)){
        rot.forEach(v => {
          const arr = Array.isArray(v) ? v : (v?.instabilities || v?.ids || []);
          (arr||[]).forEach(x => s.add(String(x)));
        });
      }
      options = Array.from(s).sort((a,b)=>Number(a)-Number(b)).map(k=>{
        const n = instabName(k);
        const label = n.zh ? `${n.zh} (${n.en})` : safeText(n.en);
        return { key:k, label };
      });
    }

    if(!options.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "（未找到异变字典）";
      sel.appendChild(opt);
      return;
    }

    options.forEach(o=>{
      const opt = document.createElement("option");
      opt.value = o.key;
      opt.textContent = o.label;
      sel.appendChild(opt);
    });
  }

  function renderReverse(){
    const selKey = document.getElementById("instabSelect").value;
    const days = Math.max(1, Math.min(365, Number(document.getElementById("reverseDays").value || 90)));
    const startIso = document.getElementById("dateInput").value || toISODate(new Date());
    const start = parseISODate(startIso);

    if(!selKey){
      document.getElementById("reverseBox").textContent = "请选择异变后自动刷新";
      return;
    }

    const target = String(selKey);
    const hits = [];
    for(let i=0;i<days;i++){
      const iso = toISODate(addDays(start,i));
      const ids = getInstabsForDate(iso);
      if(!ids) continue;
      if(ids.map(x=>String(x)).includes(target)) hits.push(iso);
    }

    const n = instabName(target);
    const title = n.zh ? `${n.zh} (${n.en})` : safeText(n.en);

    document.getElementById("reverseBox").innerHTML = hits.length
      ? `<div class="pill" style="margin-bottom:8px;">目标异变：<b>${title}</b></div>
         <div class="small">未来 ${days} 天出现 ${hits.length} 次（这些日期的 CM 95–100 都是该异变组合）：</div>
         <div class="mono" style="margin-top:6px; line-height:1.8;">${hits.join("<br/>")}</div>`
      : `<div class="pill">目标异变：<b>${title}</b></div>
         <div class="small" style="margin-top:8px;">未来 ${days} 天内未出现。</div>`;
  }

  // ========= Boot =========
  (async function init(){
    try{
      const today = new Date();
      document.getElementById("dateInput").value = toISODate(today);

      const base = new URL('.', location.href);
      const instUrl = new URL('instabilities.json', base).toString();
      const fracUrl = new URL('fractals.json', base).toString();
      const zhUrl   = new URL('zh_dict.json', base).toString();

      [instData, fracData, zh] = await Promise.all([
        fetchJson(instUrl),
        fetchJson(fracUrl),
        fetchJson(zhUrl),
      ]);

      buildCMList();

      setStatus(true,
        `✅ JSON 已加载：` +
        ` <a href="${instUrl}" target="_blank">instabilities.json</a> /` +
        ` <a href="${fracUrl}" target="_blank">fractals.json</a> /` +
        ` <a href="${zhUrl}" target="_blank">zh_dict.json</a><br/>` +
        `<span class="small">已从 fractals.json 自动锁定 Scale 95–100（CM 六个碎层）</span>`
      );

      buildInstabDropdown();

      const iso = document.getElementById("dateInput").value;
      renderDay(iso);
      renderFuture(iso, Number(document.getElementById("rangeDays").value || 30));
      renderReverse();

      document.getElementById("btnBuild").onclick = () => {
        const iso2 = document.getElementById("dateInput").value;
        renderDay(iso2);
        renderFuture(iso2, Number(document.getElementById("rangeDays").value || 30));
        renderReverse();
      };
      document.getElementById("dateInput").onchange = () => {
        const iso2 = document.getElementById("dateInput").value;
        renderDay(iso2);
        renderFuture(iso2, Number(document.getElementById("rangeDays").value || 30));
        renderReverse();
      };
      document.getElementById("rangeDays").onchange = () => {
        const iso2 = document.getElementById("dateInput").value;
        renderFuture(iso2, Number(document.getElementById("rangeDays").value || 30));
      };
      document.getElementById("reverseDays").onchange = () => renderReverse();
      document.getElementById("instabSelect").onchange = () => renderReverse();

      document.getElementById("btnToday").onclick = () => {
        document.getElementById("dateInput").value = toISODate(new Date());
        document.getElementById("btnBuild").click();
      };
      document.getElementById("btnTomorrow").onclick = () => {
        document.getElementById("dateInput").value = toISODate(addDays(new Date(),1));
        document.getElementById("btnBuild").click();
      };
      document.getElementById("btnPlus7").onclick = () => {
        const d = parseISODate(document.getElementById("dateInput").value);
        document.getElementById("dateInput").value = toISODate(addDays(d,7));
        document.getElementById("btnBuild").click();
      };
      document.getElementById("btnPlus30").onclick = () => {
        const d = parseISODate(document.getElementById("dateInput").value);
        document.getElementById("dateInput").value = toISODate(addDays(d,30));
        document.getElementById("btnBuild").click();
      };

    }catch(e){
      console.error(e);
      setStatus(false,
        `❌ 加载失败：${safeText(e.message)}<br/>
         <span class="small">请确认三个 JSON 与本页面同级，并且能直接用浏览器打开。</span>`
      );
    }
  })();
</script>
</body>
</html>
